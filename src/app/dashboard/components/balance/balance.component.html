<app-spinner *ngIf="isSpinning"></app-spinner>

<main *ngIf="!isSpinning">
  <div class="container">
    <header class="my-3">
      <div class="d-flex justify-content-between align-items-center gap-3">
        <h1>
          رصيدك الحالي:
          <span dir="ltr">{{ currentBalance }} E&#xa3;</span>
        </h1>
        <button
          type="button"
          class="btn btn-custom"
          (click)="open(addRequestModal)"
        >
          <i class="bi bi-plus"></i> اضافة طلب سحب رصيد
        </button>
      </div>
    </header>

    <div class="table-container mt-5">
      <h3>سجل باخر عمليات السحب</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">كود الطلب</th>
            <th scope="col">قيمة السحب</th>
            <th scope="col">تاريخ السحب</th>
            <th scope="col">حالة الطلب</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngIf="isSpinning">
            <td colspan="8" class="position-relative py-5">
              <app-spinner></app-spinner>
            </td>
          </tr>

          <tr>
            <td
              colspan="8"
              *ngIf="
                lastTransactions?.length === 0 && !errorMessage && !isSpinning
              "
            >
              لا تقم بأي طلبات سحب حتي الأن
            </td>
          </tr>

          <tr>
            <td colspan="8" *ngIf="errorMessage">
              {{ errorMessage }}
            </td>
          </tr>

          <tr *ngFor="let request of lastTransactions; let index = index">
            <th>{{ index }}</th>
            <td>{{ request._id }}</td>
            <td>{{ request.withdrawnAmount }}</td>
            <td>{{ request.createdAt }}</td>
            <td>{{ request.state == 0 ? "قيد المراجعة" : "تم السحب" }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<ng-template #addRequestModal let-c="close" let-d="dismiss">
  <div class="modal-header d-flex justify-content-between">
    <h4 class="modal-title" id="modal-basic-title">اضافة منتج جديد</h4>
    <button
      type="button"
      class="btn-close m-0"
      aria-label="Close"
      (click)="d('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <form class="mb-5" #addRequestForm="ngForm">
      <div class="row mb-2">
        <div class="col-md-12 form-group">
          <label for="payment_method" class="col-form-label">الفئة</label>
          <select
            class="form-select"
            name="payment_method"
            id="payment_method"
            ngModel
            #payment_method="ngModel"
            required
          >
            <option value="">أختر طريقة الدفع</option>
            <option value="etisalat cash">اتصالات كاش</option>
            <option value="vodafone cash">فودافون كاش</option>
            <option value="orange cash">اورانج كاش</option>
            <option value="we cash">وي باي</option>
          </select>
          <div class="text-danger error-div">
            <small
              *ngIf="
                (payment_method.dirty || payment_method.touched) &&
                payment_method.hasError('required')
              "
              >هذا الحقل اجباري!</small
            >
          </div>
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-md-12 form-group">
          <label for="payment_method_number" class="col-form-label"
            >رقم المحفظة</label
          >
          <input
            type="text"
            class="form-control"
            name="payment_method_number"
            id="payment_method_number"
            ngModel
            #payment_method_number="ngModel"
            required
            maxlength="11"
            pattern="^01[0-2,5]{1}[0-9]{8}$"
            [disabled]="!payment_method.valid"
          />
          <div class="text-danger error-div">
            <small
              *ngIf="
                (payment_method_number.dirty ||
                  payment_method_number.touched) &&
                payment_method_number.hasError('required')
              "
              >هذا الحقل مطلوب</small
            >
            <small
              *ngIf="
                (payment_method_number.dirty ||
                  payment_method_number.touched) &&
                payment_method_number.invalid &&
                !payment_method_number.hasError('required')
              "
              >رقم الهاتف غير صحيح</small
            >
          </div>
        </div>
      </div>

      <button
        type="button"
        class="btn btn-custom"
        [disabled]="!addRequestForm.valid"
      >
        اضافة
      </button>
    </form>
  </div>
</ng-template>
